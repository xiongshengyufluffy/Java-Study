# 偏向锁的释放 ==不等于== 偏向锁的撤销
## 偏向锁的撤销
- 偏向锁的撤销并不是把对象恢复到无锁可偏向状态（因为偏向锁并不存在锁释放的概念），而是在获取偏向锁的过程中，发现 cas 失败也就是存在线程竞争时，直接把被偏向的锁对象升级到被加了轻量级锁的状态。

- 原获得偏向锁的线程如果已经退出了临界区，也就是同步代码块执行完了，那么这个时候会把对象头设置成无锁状态并且争抢锁的线程可以基于 CAS 重新偏向但前线程。
- 如果原获得偏向锁的线程的同步代码块还没执行完，处于临界区之内，这个时候会把原获得偏向锁的线程升级为轻量级锁后继续执行同步代码块。

![20210409170114](https://xiongshengyu-1256692535.cos.ap-beijing.myqcloud.com/photos/20210409170114.png)


## 偏向锁的释放
- 不会进行偏向锁释放
![20210409170241](https://xiongshengyu-1256692535.cos.ap-beijing.myqcloud.com/photos/20210409170241.png)

# 偏向锁的释放 不等于 偏向锁的撤销
## 偏向锁的撤销
- 偏向锁的撤销并不是把对象恢复到无锁可偏向状态（因为偏向锁并不存在锁释放的概念），而是在获取偏向锁的过程中，发现 cas 失败也就是存在线程竞争时，直接把被偏向的锁对象升级到被加了轻量级锁的状态。

- 原获得偏向锁的线程如果已经退出了临界区，也就是同步代码块执行完了，那么这个时候会把对象头设置成无锁状态并且争抢锁的线程可以基于 CAS 重新偏向但前线程。
- 如果原获得偏向锁的线程的同步代码块还没执行完，处于临界区之内，这个时候会把原获得偏向锁的线程升级为轻量级锁后继续执行同步代码块。

![20210409170114](https://xiongshengyu-1256692535.cos.ap-beijing.myqcloud.com/photos/20210409170114.png)


## 偏向锁的释放
- 不会进行偏向锁释放
![20210409170241](https://xiongshengyu-1256692535.cos.ap-beijing.myqcloud.com/photos/20210409170241.png)

# 假设偏向锁偏向线程A,那线程B请求获取锁,会做哪些事情?


![20210409182620](https://xiongshengyu-1256692535.cos.ap-beijing.myqcloud.com/photos/20210409182620.png)

### 偏向锁撤销,升级为轻量级锁的逻辑
(图中笔误:对象a的偏向锁偏向的线程为t)