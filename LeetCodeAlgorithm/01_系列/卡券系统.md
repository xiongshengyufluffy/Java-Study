# card站点
- 定位
  - 凭证类卡券生命周期处理
- 主要业务
  - 接口提供(对外)
    - 领取: 【营销活动中心】
    - 冻结，回滚、取消，使用：【订单，支付系统】
  - 接口提供(内部)
    - 过期或作废
      - 定时任务过期处理
    - 生命周期变更缓存
    - 批次信息缓存(消费MQ反查,自己查询)
- 其他业务
  - 发送邮件:【消息中心】
  - 用户身份:【upc】
  - 卡券批次信息: 【营销活动中心】
- 依赖
  - 卡券创建,状态变更:mySql
  - 卡券状态变更通知:rocketmq
- 简要描述
  - 给【活动中心】提供创建，下发卡券接口；
  - 给【支付、订单】提供卡券生命周期操作接口
  - 内部有定时任务用于卡券过期


![](https://gitee.com/fluffyball/blogimage/raw/master/images/localPC/202108291035330.png)

# coupon站点
- 定位
  - 有抵扣金额卡券生命周期处理
- 主要业务
  - 接口提供(对外)
    - 领取: 【网关，营销活动中心】
    - 冻结，回滚、取消，使用：【订单，支付系统】
  - 接口提供(内部)
    - 过期或作废
      - 定时任务过期处理
    - 生命周期变更缓存
    - 批次信息缓存(消费MQ反查,自己查询)
- 其他业务
  - 发送邮件:【消息中心】
  - 用户身份:【upc】
  - 发送信息:【CRB】
  - 商品信息:【商家】
  - 卡券批次信息: 【营销活动中心】
- 依赖
  - 卡券创建,状态变更:mySQL
  - 卡券状态变更通知:rocketmq
- 问题
  - 目前站点包含过多非生命周期处理外的业务，红点，BI上报，mq发送和对账处理等，后续此类业务应放在其他站

# couponQuery2c站点
- 定位
  - 提供卡券的TOC查询和抵扣计算
- 主要业务
  - 接口提供(对外):【活动、支付、订单、**网关**、售后、前台商品服务、商家服务】
    - 单查、批量查询
    - 分页展示
- 依赖
  - 缓存查询:redis
  - 数据库:mySQL
    - 为了抗并发有些卡券做了分表
- 简要描述
  - 查询条件通常不复杂,例如id + 状态
    - id可以定位分表以及命中索引
  - **对及时性要求比较高**,所以会维护缓存
- 相关接口
# couponQuery2b站点
- 定位
  - 提供卡券的TOB查询
- 依赖
  - 数据库:mongodb,mysql
    - mongodb全量维护了mySQL中的数据
    - 主要针对复杂查询(一个时间跨度范围内)
  - rocketMQ:
    - 消费mq,维护卡券状态
- 简要描述
  - 主要针对复杂查询
  - tob接口的调用方对于**时延的容忍性较强**
- 问题
  - 目前站点会进行mongodb数据的维护,此部分可迁移到coupondw站点
- 相关接口

# coupondw站点
- 定位
  - 卡券的基础数据处理
    - 数据归档
    - 数据对账
    - 个人资产维护
- 简要描述
  - 各类凭证日志记录处理
- 依赖
  - 数据库:mysql,redis
    - 查询数据,redis缓存用于维护个人资产
  - rocketMQ:
    - 消费mq,维护卡券状态

# couponspt站点
- 定位:
  - 处理卡券的支撑业务
    - BI上报
    - **红点展示**
    - mq缓存维护,卡券信息统计监控等
- 依赖
  - 数据库:mysql,redis
    - 查询数据
    - 维护缓存
  - rocketMQ
    - 消费mq